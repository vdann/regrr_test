<!DOCTYPE HTML>

<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

	<title>(( server.title )) - Реестр результатов анализов и тестирования</title>

	<link rel="shortcut icon" type="image/png" href="/favicon.png">
	<link rel="stylesheet" href="/static/_design/assets/css/main.css" />
	<link rel="stylesheet" href="/static/_design/assets/css/main_ext.css" />

	<style>
		.form-profile {
			max-width: 700px;
		}
	</style>

	<script src="/static/_design/extern/es6-promise.js-v4.2.6/es6-promise.auto.js"></script>
	<script src="/static/_design/extern/axios.js-v0.18.0/axios.js"></script>
	<script src="/static/_design/extern/lodash.js-v4.17.11/lodash.js"></script>
	<script src="/static/_design/extern/vue.js-v2.5.22/vue.js"></script>

</head>
<body class="is-preload">

	(% import "macros.html" as macros %)

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Main -->
		<div id="main">
			<div class="inner">

				<!-- Header -->
				<header id="header">
					<a href="/" class="logo"><h2>Реестр результатов анализов и&nbsp;тестирования</h2></a>
				</header>


				<!-- Banner -->
				<section id="banner">

					<div class="content" id="analizes">

						<header class="major1 mb-2em">

							(% if server.breadcrumbs %)

							<!--Breadcrumbs-->
							<div class="breadcrumbs">
								(% for item in server.breadcrumbs %)

								(% if item.href %)
								<a href="(( item.href ))">(( item.text | safe ))</a>
								(% else %)
								<span>(( item.text | safe ))</span>
								(% endif %)

								(% if not loop.last %)
								<span class="breadcrumbs-sep">»</span>
								(% endif %)

								(% endfor %)
							</div>

							(% endif %)

							(% if server.prevnext %)

							<!-- PrevNext -->
							<div class="prevnext mt-1em">

								(% if server.prevnext.prev: %)
								<a href="((server.prevnext.prev.href))"
								   (% if server.prevnext.prev.title %)
								   title="((server.prevnext.prev.title))"
								   (% endif %)>
									<i class="fa fa-2x fa-caret-left"></i>
								</a>
								(% else %)
								<i class="fa fa-2x fa-caret-left"></i>
								(% endif %)

								&nbsp;
								&nbsp;

								(% if server.prevnext.next: %)
								<a href="((server.prevnext.next.href))"
								   (% if server.prevnext.next.title %)
								   title="((server.prevnext.next.title))"
								   (% endif %)>
									<i class="fa fa-2x fa-caret-right"></i>
								</a>
								(% else %)
								<i class="fa fa-2x fa-caret-right"></i>
								(% endif %)

							</div>

							(% endif %)

						</header>

						(% if server.isOk %)
						<br>

						<div class="row">
							<div class="col-12">
								<a class="button primary"
								   href="/patient/((server.patient_id))/analysis_type/((server.analysis_type))/analysis_add"
								   title="Добавить новый анализ">Добавить</a>
							</div>
						</div>
						<br>


						<div v-if="analyzes.length" class="table-wrapper">
							<table class="alt">
								<thead>
									<tr>
										<th>№</th>
										<th>#</th>
										<th>Результат</th>
										<th>Исследование выполнил</th>
										<th>Дата выполнения</th>
									</tr>
								</thead>
								<tbody>
									<tr v-for="(analysis, i) in analyzes" key="analysis.id">
										<td v-html="i + 1"></td>
										<td v-html="makeLinkAnalysis(analysis, analysis.id)"></td>
										<td v-html="makeLinkAnalysis(analysis, analysis.result)"></td>
										<td v-html="analysis.user"></td>
										<td v-html="analysis.date_of_creation"></td>
									</tr>
								</tbody>
								<tfoot>
									<tr>
										<!--										<td v-html="patients.length"></td>
							-->
									</tr>
								</tfoot>
							</table>
						</div>

						<p v-else>
							Нет записей
						</p>
						(% endif %)
					</div>
				</section>

			</div>
		</div>

		(( macros.sidebar(server) ))

	</div>

	<script>
		var rx_email = /^(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/gm;
		var data = {};

		try {
			((server.data | safe));
		}
		catch (e) {
			console.log('Серверные данные не были проинициализированы');
		}

		var icon_ok = 'fa fa-2x fa-check clr-green';
		var icon_fail = 'fa fa-2x fa-exclamation-triangle clr-red';
		var icon_wait = 'fa fa-2x fa-refresh fa-spin clr-blue';


		data.id = data.id || '';
		data.id_icon = null;
		data.lastname = data.lastname || '';
		data.lastname_icon = null;
		data.firstname = data.firstname || '';
		data.firstname_icon = null;
		data.middlename = data.middlename || '';
		data.middlename_icon = null;
		data.date_of_birth = data.date_of_birth || '';
		data.date_of_birth_icon = null;
		data.department = data.department || '';
		data.department_icon = null;
		data.diagnosis = data.diagnosis || '';
		data.diagnosis_icon = null;

		//data.editing = data.editing || true;
		//data.saving = data.saving || false;

		function makeUrlFromRoute(route, params) {
			for (key in params) {
				var param = params[key];
				var t = typeof param;
				if (t === 'string' || t === 'number')
					route = route.replace(new RegExp('<' + key + '>', 'gm'), param);
			}

			if (/<\w+(\:\w*)*>/gm.test(route))
				console.warn('makeUrlFromRoute => Не все параметры маршрута заданы', route);

			return route;
		}

		data.route_patient_analysis_type_analysis = data.route_patient_analysis_type_analysis
			|| '/patient/<patient_id>/analysis_type/<analysis_type>/analysis/<analysis_id>';

		// test
		// route_1 = '/patient_<patient_id>/analysis_type_<analysis_type>/analysis_<analysis>/ <patient_id>';
		// var u1 = makeUrlFromRoute(route_1, {patient_id: 100});
		// var u2 = makeUrlFromRoute(route_1, {patient_id: 100, analysis_type: 10, analysis: 0});

		var app = new Vue({
			el: '#analizes',
			/*
				data['patient_id'] = patient_id
				data['analysis_type'] = analysis_type
				data['analyzes'] = [{
				}]
			*/
			data: data,
			methods: {
				makeLink: function (href, text) {
					return '<a href="' + href + '">' + text + '</a>';
				},

				makeLinkAnalysis: function (analysis, text) {
					var href = makeUrlFromRoute(this.route_patient_analysis_type_analysis, {
						patient_id: this.patient_id,
						analysis_type: this.analysis_type,
						analysis_id: analysis.id
					});
					
					var s = this.makeLink(href, text);
					return s;
				}
			}
		});

		/*
		var app = new Vue({
			el: '#wrapper',
			data: data,

			created: function () {
				this.debouncedTestUsername = _.debounce(this.testUsername, 500)
			},

			computed: {
				isEnableAdd: function () {
					if (
						this.username_icon == icon_ok
						&& this.lastname_icon == icon_ok
						&& this.firstname_icon == icon_ok
						&& this.middlename_icon == icon_ok
						&& this.position_icon == icon_ok
						&& this.email_icon == icon_ok
						)
						return true;

					return false;
				}
			},
			watch: {
				username: function (val, valOld) {
					console.log('App.watch:username', val);
					this.username_icon = icon_wait;
					this.debouncedTestUsername();
				},
				lastname: function (val, valOld) {
					this.lastname_icon = val != '' ?  icon_ok : icon_fail;
				},
				firstname: function (val, valOld) {
					this.firstname_icon = val != '' ? icon_ok : icon_fail;
				},
				middlename: function (val, valOld) {
					this.middlename_icon = val != '' ? icon_ok : icon_fail;
				},
				position: function (val, valOld) {
					this.position_icon = val != '' ? icon_ok : icon_fail;
				},
				email: function (val, valOld) {
					// var isOk = rx_email.test(val);
					var isOk = val.search(rx_email) != -1;
					this.email_icon = isOk ? icon_ok : icon_fail;
				},
			},
			methods: {
				testUsername: function () {
					if (this.username == '') {
						this.username_icon = icon_fail;
						return;
					}

					this.username_icon = icon_wait;

					var vm = this;
					axios.post('/api/v1.0/test_username', {
						username: this.username
					})
					.then(function (response) {
						console.log(response.data.result);
						vm.username_icon = response.data.result ? icon_ok : icon_fail;
					})
					.catch(function (error) {
						vm.username_icon = icon_fail;
						console.log('Error!');
					});
				}
			}
		});
		*/

	</script>

	<!-- Scripts -->
	<script src="/static/_design/assets/js/jquery.min.js"></script>
	<script src="/static/_design/assets/js/browser.min.js"></script>
	<script src="/static/_design/assets/js/breakpoints.min.js"></script>
	<script src="/static/_design/assets/js/util.js"></script>
	<script src="/static/_design/assets/js/main.js"></script>

</body>
</html>