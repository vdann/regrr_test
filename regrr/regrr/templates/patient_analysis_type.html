(% extends "layout.html" %)
(% import "macros.html" as macros %)


(% block block_head %)
<style>
	#form_profile {
		max-width: 700px;
	}
</style>
(% endblock %)


(% block content %)

	<div>

		<div class="row">
			<div class="col-12">
				<a class="button primary"
					href="/patient/((server.patient_id))/analysis_type/((server.analysis_type))/analysis_add"
					title="Добавить новый анализ">Добавить</a>
			</div>
		</div>
		<br>

		(% if server.pagination.list|length == 0 %)

			<p>Нет записей</p>
		
		(% else %)

			<div id="analizes" class="table-wrapper">
				<table class="alt">
					<thead>
						<tr>
							<th>№</th>
							<th>#</th>
							<th>Результат</th>
							<th>Исследование выполнил</th>
							<th>Дата выполнения</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="(analysis, i) in analyzes" :key="i">
							<td v-html="analyzes_offset + i + 1"></td>
							<td v-html="makeLinkAnalysis(analysis, analysis.id)"></td>
							<td v-html="makeLinkAnalysis(analysis, analysis.result)"></td>
							<td v-html="analysis.user"></td>
							<td v-html="analysis.date_of_creation"></td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<!--										<td v-html="patients.length"></td>
							-->
						</tr>
					</tfoot>
				</table>
			</div>

			(( macros.pagination(server.pagination) ))



			<script>
				var data = {};

				try {
					((server.data | safe));
				}
				catch (e) {
					console.log('Серверные данные не были проинициализированы');
				}

				data.analyzes_offset = data.analyzes_offset || 0;

				//data.editing = data.editing || true;
				//data.saving = data.saving || false;

				function makeUrlFromRoute(route, params) {
					for (key in params) {
						var param = params[key];
						var t = typeof param;
						if (t === 'string' || t === 'number')
							route = route.replace(new RegExp('<' + key + '>', 'gm'), param);
					}

					if (/<\w+(\:\w*)*>/gm.test(route))
						console.warn('makeUrlFromRoute => Не все параметры маршрута заданы', route);

					return route;
				}

				data.route_patient_analysis_type_analysis = data.route_patient_analysis_type_analysis
					|| '/patient/<patient_id>/analysis_type/<analysis_type>/analysis/<analysis_id>';

				// test
				// route_1 = '/patient_<patient_id>/analysis_type_<analysis_type>/analysis_<analysis>/ <patient_id>';
				// var u1 = makeUrlFromRoute(route_1, {patient_id: 100});
				// var u2 = makeUrlFromRoute(route_1, {patient_id: 100, analysis_type: 10, analysis: 0});

				var app = new Vue({
					el: '#analizes',
					/*
						data['patient_id'] = patient_id
						data['analysis_type'] = analysis_type
						data['analyzes'] = [{
						}]
					*/
					data: data,
					methods: {
						makeLink: function (href, text) {
							return '<a href="' + href + '">' + text + '</a>';
						},

						makeLinkAnalysis: function (analysis, text) {
							var href = makeUrlFromRoute(this.route_patient_analysis_type_analysis, {
								patient_id: this.patient_id,
								analysis_type: this.analysis_type,
								analysis_id: analysis.id
							});

							var s = this.makeLink(href, text);
							return s;
						}
					}
				});

			</script>

		(% endif %)

	</div>



(% endblock %)
