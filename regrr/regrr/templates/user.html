(% extends "layout.html" %)
(% import "macros.html" as macros %)


(% block block_head %)
<style>
	#form_profile {
		max-width: 700px;
	}
</style>
(% endblock %)



(% block content %)

	(% if not server.isOk %)
		<h2>Пользователь, <b>"(( server.title ))"</b>, не найден!</h2>
	(% else %)
		<form method="post" action="#" id="form_profile">
			<div v-cloak class="row gtr-uniform">

				<!-- label + input - username -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Логин" disabled />
				</div>
				<div class="col-0 col-2-xsmall align-right">
					<div v-if="username_icon" class="icon-va-center">
						<i class="[username_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="username" id="username"
						class="input-static"
						:value="username"
						@input="username = $event.target.value"
						placeholder="Логин"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="username_icon" class="icon-va-center">
						<i class="[username_icon]"></i>
					</div>
				</div>


				<!-- label + input - lastname -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Фамилия" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="lastname_icon" class="icon-va-center">
						<i class="[lastname_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="lastname" id="lastname"
						class="input-static"
						:value="lastname"
						@input="lastname = $event.target.value"
						placeholder="Фамилия"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="lastname_icon" class="icon-va-center">
						<i class="[lastname_icon]"></i>
					</div>
				</div>

				<!-- label + input - firstname -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Имя" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="firstname_icon" class="icon-va-center">
						<i class="[firstname_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="firstname" id="firstname"
						class="input-static"
						:value="firstname"
						@input="firstname = $event.target.value"
						placeholder="Имя"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="firstname_icon" class="icon-va-center">
						<i class="[firstname_icon]"></i>
					</div>
				</div>

				<!-- label + input - middlename -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Отчество" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="middlename_icon" class="icon-va-center">
						<i class="[middlename_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="middlename" id="middlename"
						class="input-static"
						:value="middlename"
						@input="middlename = $event.target.value"
						placeholder="Отчество"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="middlename_icon" class="icon-va-center">
						<i class="[middlename_icon]"></i>
					</div>
				</div>


				<!-- label + input position -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Должность" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="position_icon" class="icon-va-center">
						<i class="[position_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="position" id="position"
						class="input-static"
						:value="position"
						@input="position = $event.target.value"
						placeholder="Должность"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="position_icon" class="icon-va-center">
						<i class="[position_icon]"></i>
					</div>
				</div>


				<!-- label + input email -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Почта" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="email_icon" class="icon-va-center">
						<i class="[email_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="email" name="email" id="email"
						class="input-static"
						:value="email"
						@input="email = $event.target.value"
						placeholder="Почта"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="email_icon" class="icon-va-center">
						<i class="[email_icon]"></i>
					</div>
				</div>

				<!-- label + input date_of_creation -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Дата создания" disabled />
				</div>

				<div class="col-0 col-2-xsmall align-right">
					<div v-if="date_of_creation_icon" class="icon-va-center">
						<i class="[date_of_creation_icon]"></i>
					</div>
				</div>

				<div class="col-7 col-12-xsmall">
					<input type="text" name="date_of_creation" id="date_of_creation"
						class="input-static"
						:value="date_of_creation"
						@input="date_of_creation = $event.target.value"
						placeholder="Дата создания"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="date_of_creation_icon" class="icon-va-center">
						<i class="[date_of_creation_icon]"></i>
					</div>
				</div>


				<!-- label + input date_of_last_visit -->
				<div class="col-4 col-10-xsmall">
					<input class="input-static input-static-bold" type="text" value="Последний визит" disabled />
				</div>
				<div class="col-0 col-2-xsmall align-right">
					<div v-if="date_of_last_visit_icon" class="icon-va-center">
						<i class="[date_of_last_visit_icon]"></i>
					</div>
				</div>
				<div class="col-7 col-12-xsmall">
					<input type="text" name="date_of_last_visit" id="date_of_last_visit"
						class="input-static"
						:value="date_of_last_visit"
						@input="date_of_last_visit = $event.target.value"
						placeholder="Последний визит"
						required
						disabled />
				</div>
				<div class="col-1 col-0-xsmall">
					<div v-if="date_of_last_visit_icon" class="icon-va-center">
						<i class="[date_of_last_visit_icon]"></i>
					</div>
				</div>

				<!-- submit -->
				<!--
	<div class="col-12">
		<ul class="actions">
			<li>
				<input
					type="submit"
					value="Добавить"
					class="primary"
					:disabled="!isEnableAdd"
					/>
			</li>
		</ul>
	</div>
	-->
			</div>
		</form>
	(% endif %)

	<script>
		var rx_email = /^(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/gm;
		var data = {};

		try {
			((server.data | safe));
		}
		catch (e) {
			console.log('Серверные данные не были проинициализированы');
		}

		var icon_ok = 'fa fa-2x fa-check clr-green';
		var icon_fail = 'fa fa-2x fa-exclamation-triangle clr-red';
		var icon_wait = 'fa fa-2x fa-refresh fa-spin clr-blue';


		data.username = data.username || '';
		data.username_icon = null;
		data.lastname = data.lastname || '';
		data.lastname_icon = null;
		data.firstname = data.firstname || '';
		data.firstname_icon = null;
		data.middlename = data.middlename || '';
		data.middlename_icon = null;
		data.position = data.position || '';
		data.position_icon = null;
		data.email = data.email || '';
		data.email_icon = null;
		data.date_of_creation = data.date_of_creation || '';
		data.date_of_creation_icon = null;
		data.date_of_last_visit = data.date_of_last_visit || '';
		data.date_of_last_visit_icon = null;

		

		//data.editing = data.editing || true;
		//data.saving = data.saving || false;

		var app = new Vue({
			el: '#form_profile',
			data: data,

			created: function () {
				this.debouncedTestUsername = _.debounce(this.testUsername, 500)
			},

			computed: {
				isEnableAdd: function () {
					if (
						this.username_icon == icon_ok
						&& this.lastname_icon == icon_ok
						&& this.firstname_icon == icon_ok
						&& this.middlename_icon == icon_ok
						&& this.position_icon == icon_ok
						&& this.email_icon == icon_ok
						)
						return true;

					return false;
				}
			},
			watch: {
				username: function (val, valOld) {
					console.log('App.watch:username', val);
					this.username_icon = icon_wait;
					this.debouncedTestUsername();
				},
				lastname: function (val, valOld) {
					this.lastname_icon = val != '' ?  icon_ok : icon_fail;
				},
				firstname: function (val, valOld) {
					this.firstname_icon = val != '' ? icon_ok : icon_fail;
				},
				middlename: function (val, valOld) {
					this.middlename_icon = val != '' ? icon_ok : icon_fail;
				},
				position: function (val, valOld) {
					this.position_icon = val != '' ? icon_ok : icon_fail;
				},
				email: function (val, valOld) {
					// var isOk = rx_email.test(val);
					var isOk = val.search(rx_email) != -1;
					this.email_icon = isOk ? icon_ok : icon_fail;
				},
			},
			methods: {
				testUsername: function () {
					if (this.username == '') {
						this.username_icon = icon_fail;
						return;
					}

					this.username_icon = icon_wait;

					var vm = this;
					axios.post('/api/v1.0/test_username', {
						username: this.username
					})
					.then(function (response) {
						console.log(response.data.result);
						vm.username_icon = response.data.result ? icon_ok : icon_fail;
					})
					.catch(function (error) {
						vm.username_icon = icon_fail;
						console.log('Error!');
					});
				}
			}
		});

	</script>

(% endblock %)
